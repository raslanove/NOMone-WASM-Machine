#include <WasmMachine.h>
#include <NSystemUtils.h>
#include <NError.h>
#include <NVector.h>

void NMain(int argc, char *argv[]) {

    char watCode[] =
            "(module\n"
            "  (type (;0;) (func))\n"
            "  (type (;1;) (func (param i32 i32 i32) (result i32)))\n"
            "  (type (;2;) (func (param i32 i32)))\n"
            "  (type (;3;) (func (param i32 i32) (result i32)))\n"
            "  (type (;4;) (func (param i32)))\n"
            "  (type (;5;) (func (param f64) (result i32)))\n"
            "  (type (;6;) (func (param i32) (result i32)))\n"
            "  (type (;7;) (func (param i32 i32 i32)))\n"
            "  (type (;8;) (func (result i32)))\n"
            "  (type (;9;) (func (param i32 f64 i32)))\n"
            "  (type (;10;) (func (param i32 i32 i32 i32 i32) (result i32)))\n"
            "  (func $__wasm_call_ctors (type 0))\n"
            "  (func $initialize (type 4) (param i32)\n"
            "    block  ;; label = @1\n"
            "      local.get 0\n"
            "      i32.eqz\n"
            "      br_if 0 (;@1;)\n"
            "      local.get 0\n"
            "      call_indirect (type 0)\n"
            "    end)"
            "  (func $terminate (type 0))\n"
            "  (func $strlen (type 6) (param i32) (result i32)\n"
            "    (local i32 i32 i32)\n"
            "    i32.const 0\n"
            "    local.set 1\n"
            "    loop  ;; label = @1\n"
            "      local.get 0\n"
            "      local.get 1\n"
            "      i32.add\n"
            "      local.set 2\n"
            "      local.get 1\n"
            "      i32.const 1\n"
            "      i32.add\n"
            "      local.tee 3\n"
            "      local.set 1\n"
            "      local.get 2\n"
            "      i32.load8_u\n"
            "      br_if 0 (;@1;)\n"
            "    end\n"
            "    local.get 3\n"
            "    i32.const -1\n"
            "    i32.add)"
            "  (func $startsWith (type 3) (param i32 i32) (result i32)\n"
            "    (local i32 i32 i32)\n"
            "    block  ;; label = @1\n"
            "      block  ;; label = @2\n"
            "        local.get 0\n"
            "        i32.load8_u\n"
            "        local.tee 2\n"
            "        br_if 0 (;@2;)\n"
            "        i32.const 0\n"
            "        local.set 3\n"
            "        br 1 (;@1;)\n"
            "      end\n"
            "      local.get 0\n"
            "      i32.const 1\n"
            "      i32.add\n"
            "      local.set 4\n"
            "      i32.const 0\n"
            "      local.set 0\n"
            "      loop  ;; label = @2\n"
            "        block  ;; label = @3\n"
            "          local.get 1\n"
            "          local.get 0\n"
            "          i32.add\n"
            "          i32.load8_u\n"
            "          local.tee 3\n"
            "          br_if 0 (;@3;)\n"
            "          local.get 0\n"
            "          local.set 3\n"
            "          br 2 (;@1;)\n"
            "        end\n"
            "        block  ;; label = @3\n"
            "          local.get 2\n"
            "          i32.const 255\n"
            "          i32.and\n"
            "          local.get 3\n"
            "          i32.eq\n"
            "          br_if 0 (;@3;)\n"
            "          i32.const 0\n"
            "          return\n"
            "        end\n"
            "        local.get 4\n"
            "        local.get 0\n"
            "        i32.add\n"
            "        local.set 2\n"
            "        local.get 0\n"
            "        i32.const 1\n"
            "        i32.add\n"
            "        local.tee 3\n"
            "        local.set 0\n"
            "        local.get 2\n"
            "        i32.load8_u\n"
            "        local.tee 2\n"
            "        br_if 0 (;@2;)\n"
            "      end\n"
            "    end\n"
            "    local.get 1\n"
            "    local.get 3\n"
            "    i32.add\n"
            "    i32.load8_u\n"
            "    i32.eqz)\n"
            "  (table (;0;) 62 funcref)\n"
            ")\n";

    struct NWM_WasmMachine* machine = NWM.createReferenceMachine();
    boolean result = machine->parseWatCode(machine, watCode);
    machine->destroyAndFree(machine);

    NSystemUtils.logI("Parsing result", "%s\n", (result==1 ? "True" : "False"));

    NError.logAndTerminate();
}
